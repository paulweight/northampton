<?php
	include_once("utilities/JaduStatus.php");	
	include_once("JaduStyles.php"); 
	include_once("egov/JaduEGovJoinedUpServices.php");
	include_once("egov/JaduEGovJoinedUpServicesContacts.php");
	include_once("egov/JaduPIDList.php");
	include_once("JaduCategories.php");
	include_once("websections/JaduFAQ.php");
	include_once("websections/JaduDocuments.php");
	include_once("egov/JaduXFormsForm.php");
	
	// Pid page specific stuff - only difference to service_info.php other than include paths
	function processURI() {
		global $REQUEST_URI;
		$array = explode("/",$REQUEST_URI);
		$num = count($array);
		$url_array = array();
			
		// start at 2, as 1 = 'pid'
		for ($i = 2 ; $i < $num ; $i++) {	         
			$url_array[] = $array[$i];  
		}
		
		return $url_array;
	}
	
	$url_array = processURI();
	$pid = $url_array[0];
	$services = getAllServicesWithPID_ID($pid);
	
	if (sizeof($services) < 1) {
		$serviceID = -1;
	}
	else {
		$serviceID = $services[0]->id;
	}
	//	End differnces

	$PID = null;
	$allLGCLCategories = array();

	if (isset($serviceID)) {
		$service = getService($serviceID);
		if ($service->id != -1) {
			$lgclList = new CategoryList(BESPOKE_CATEGORY_LIST_NAME, BESPOKE_CATEGORY_LIST_FILE);
			$allCategories = getAllCategoriesOfType(SERVICES_CATEGORIES_TABLE, $service->id);
			foreach ($allCategories as $category) {
				$allLGCLCategories[] = $lgclList->getCategory($category->categoryID);
			}
			
			$serviceToContacts = getAllServicesToContactsForService($serviceID);
			if ($service->PID_ID > 0) {
				$PID = getPIDListElement($service->PID_ID);
			}
		}
	}
	
	if (!isset($startsWith) || !preg_match("/^[a-zA-Z]+$/", $startsWith)) // so a user can change to lower or upper if required
		$startsWith = "A";
	
	$startsWith = strtoupper($startsWith);
	
	$allServices = getAllServicesWithTitleAliases();
	$validLetters = getAllValidAlphabetLetters($allServices);

	$title = $service->title;
	if (strlen($title) > 64) {
		$title = substr($title, 0, 61) . "...";
	}

	$breadcrumb = 'pidscript';
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
	<title><?php print $title; ?> | <?php print METADATA_GENERIC_COUNCIL_NAME;?></title>

	<?php include_once($HOME . "site/includes/stylesheets.php"); ?>
	<?php include_once($HOME . "site/includes/metadata.php"); ?>

	<meta name="Keywords" content="<?php print $service->title;?>, services, a-z, <?php print METADATA_GENERIC_COUNCIL_KEYWORDS;?>" />
	<meta name="Description" content="<?php print $service->title;?> - <?php print METADATA_GENERIC_COUNCIL_NAME;?> A to Z of services" />

<?php
	list($metadata, $gclString, $lgclString, $gclNonPreferred) = getAllMetadata(SERVICES_METADATA_TABLE, SERVICES_CATEGORIES_TABLE, $serviceID);
	$meta = new JaduMetadata();
	
	if ($gclString != '' && $lgclString != '' && $meta != $metadata) {
		printMetadata(SERVICES_METADATA_TABLE, SERVICES_CATEGORIES_TABLE, $serviceID, $service->title, "http://".$DOMAIN.$_SERVER['PHP_SELF']."?".$_SERVER['QUERY_STRING']); 
	}
	else {
?>

	<meta name="DC.title" lang="en" content="<?php print $service->title;?> - <?php print METADATA_GENERIC_COUNCIL_NAME;?> A to Z of services" />
	<meta name="DC.description" lang="en" content="<?php print $service->title;?> - <?php print METADATA_GENERIC_COUNCIL_NAME;?> A to Z of services" />

	<meta name="DC.subject" lang="en" scheme="eGMS.IPSV" content="Local government;Government, politics and public administration" />
	<meta name="DC.subject" lang="en" content="Council, government and democracy" />
<?php
	}

	if ($service->PID_ID > 0) {
?>

	<meta name="eGMS.subject.service" lang="en" scheme="LGSL" content="<?php print $PID->PIDName;?>" />
<?php
	}
?>
</head>
<body>
<!-- ########## MAIN STRUCTURE ######### -->
<?php include($HOME . "site/includes/opening.php"); ?>
<!-- ########################## -->
	
<?php
	if ($service->id == -1) {
?>
	<h2>Sorry - this service is not available.</h2>
<?php
	} 
	else {
?>

		<!-- DESCRIPTION -->
		<div class="displayBox">
			<div class="displayBoxIn">
			<h2><?php print $service->title; ?>: Outline</h2>
			<div class="byEditor">
			<?php print $service->content;?>
			</div>
			</div>
		</div>

<?php 
		$formsWithCategory = array();
		foreach ($allLGCLCategories as $lgclCategory) {
			$formsWithCategory = array_merge($formsWithCategory, getAllCategoryItemsOfType(XFORMS_FORM_CATEGORIES_TABLE, $lgclCategory->id, "LGCL"));
		}
		if (sizeof($formsWithCategory) > 0) {
?>
		<div class="displayBox">
			<div class="displayBoxIn">
			<h2>Online Services</h2>
			<ul class="list">
<?php
			foreach ($formsWithCategory as $formWithCategory) {
				$form = getXFormsForm($formWithCategory->itemID, true);
				if ($form != -1) {
					print "<li><a href=\"http://$DOMAIN/site/scripts/xforms_form.php?formID=$form->id\">$form->title</a></li>";
				}
			}
?>
			</ul>
			</div>
		</div>
<?php
		}
?>

<?php
		if (strlen(trim($service->eligibility)) > 0) {
?>
		<div class="displayBox">
			<div class="displayBoxIn">
			<h2>Eligibility</h2>
			<?php print $service->eligibility;?>
			</div>
		</div>
<?php
		}
?>
		
<?php
		if (strlen(trim($service->accessibility)) > 0) {
?>
		<div class="displayBox">
			<div class="displayBoxIn">
			<h2>Accessibility</h2>
			<?php print $service->accessibility;?>
		</div>
		</div>
<?php
		}
?>
		
<?php
		if (strlen(trim($service->availability)) > 0) {
?>
		<div class="displayBox">
			<div class="displayBoxIn">
			<h2>Availability</h2>
			<?php print $service->availability;?>
			</div>
		</div>
<?php
		}
?>

<?php 
		$faqsWithCategory = array();
		foreach ($allLGCLCategories as $lgclCategory) {
			$faqsWithCategory = array_merge($faqsWithCategory, getAllCategoryItemsOfType(FAQS_CATEGORIES_TABLE, $lgclCategory->id, "LGCL"));
		}

		if (sizeof($faqsWithCategory) > 0) {
?>
		<div class="displayBox">
			<div class="displayBoxIn">
				<h2>Common Questions</h2>
				<ul class="list">
<?php
			foreach ($faqsWithCategory as $faqWithCategory) {
				$faq = getFAQ($faqWithCategory->itemID);
				if ($faq != -1) {
					print "<li><a href=\"http://$DOMAIN/site/scripts/faq_info.php?faqID=$faq->id\">$faq->question</a></li>";
				}
			}
?>
		</ul>
		</div>
	</div>
<?php
		}
?>
		
<?php 
		$docsWithCategory = array();
		foreach ($allLGCLCategories as $lgclCategory) {
			$docsWithCategory = array_merge($docsWithCategory, getAllCategoryItemsOfType(DOCUMENTS_CATEGORIES_TABLE, $lgclCategory->id, "LGCL"));
		}
		if (sizeof($docsWithCategory) > 0) {
?>
		<div class="displayBox">
			<div class="displayBoxIn">
		<h2>Further Information</h2>
		<ul class="list">
<?php
			foreach ($docsWithCategory as $docWithCategory) {
				$doc = getDocument($docWithCategory->itemID, true, false);
				if ($doc != -1) {
					$docHeader = getDocumentHeader($doc->headerOriginalID, true);
					print "<li><a href=\"http://$DOMAIN/site/scripts/documents_info.php?documentID=$doc->id\">$docHeader->title</a></li>";
				}
			}
?>
		</ul>
		</div>
	</div>
<?php
		}
?>

		<!-- CONTACTS -->
<?php
		if (sizeof($serviceToContacts) > 0) {
?>
		<div class="displayBox">
		<div class="displayBoxIn">
		<div class="contactPage">
			<ul>
<?php
			foreach ($serviceToContacts as $sToC) {
				$serviceContact = getServiceContact($sToC->contactID);

				if ($serviceContact->name != "") 		print "<li><h2>Contact: $serviceContact->name $serviceContact->jobTitle</h2></li>";
				if ($serviceContact->department != "")	print "<li class=\"first\"><strong>Department: $serviceContact->department</strong></li>";
				if ($serviceContact->email != "")		print "<li class=\"icoEmail\">Email: <a href=\"mailto:$serviceContact->email\">$serviceContact->email</a></li>";
				if ($serviceContact->telephone != "")	print "<li class=\"icoPhone\">Telephone: $serviceContact->telephone</li>";
				if ($serviceContact->fax != "")			print "<li class=\"icoFax\">Fax: $serviceContact->fax</li>";
				if ($serviceContact->url != "")			print "<li class=\"icoGlass\">Visit: <a href=\"$serviceContact->url\">$serviceContact->url</a></li>";
				if (EGOV_SERVICE_CONTACT_MODE != "Complex" && $serviceContact->address != "") {
					print "<li class=\"icoAddress\">" . nl2br($serviceContact->address) . "</li>";
				}
				if (EGOV_SERVICE_CONTACT_MODE == "Complex") {
					$serviceContact->createAddressStringFromBS7666();
					if (trim($serviceContact->address) != "") {
						print "<li class=\"icoAddress\">" . nl2br($serviceContact->address) . "</li>";
					}
				}
			}
?>
			</ul>
			</div>
			</div>
		</div>

<?php
		}

?>

		
<?php
		if ($PID != null) {
?>
	<p class="pid">PID No: <?php print $PID->id;?></p>
<?php
		}

	}
?>

<!-- ###################################### -->
<?php include($HOME . "site/includes/closing.php"); ?>